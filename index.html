<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Web App Manifest for "Add to Home Screen" -->
    <link rel="manifest" href="manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Smart Plug">
    <meta name="apple-mobile-web-app-title" content="Smart Plug">
    <meta name="theme-color" content="#1a202c">
    <meta name="msapplication-navbutton-color" content="#1a202c">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <title>Smart Plug Controller</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            touch-action: manipulation; /* Disables double-tap to zoom on mobile */
        }
        .toggle-button {
            transition: background-color 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
        }
        .toast {
            visibility: hidden;
            opacity: 0;
            transition: visibility 0s 0.5s, opacity 0.5s linear;
        }
        .toast.show {
            visibility: visible;
            opacity: 1;
            transition: opacity 0.5s linear;
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen">

    <div class="w-full max-w-sm p-6 md:p-8 bg-gray-800 rounded-2xl shadow-2xl space-y-6">
        
        <!-- Header -->
        <div>
            <h1 class="text-3xl font-bold text-center text-cyan-400">Smart Plug</h1>
            <p id="status-text" class="text-center text-gray-400 mt-1 font-medium text-lg">Not Connected</p>
        </div>

        <!-- Power Button -->
        <div class="flex justify-center py-6">
            <button id="toggle-button" class="relative w-40 h-40 rounded-full flex items-center justify-center bg-gray-700 toggle-button shadow-lg" disabled>
                <!-- Power Icon SVG -->
                <svg xmlns="http://www.w3.org/2000/svg" class="h-20 w-20 text-gray-500 transition-colors duration-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.636 5.636a9 9 0 1012.728 0M12 3v9" />
                </svg>
            </button>
        </div>

        <!-- IP Configuration -->
        <div class="space-y-4">
            <div>
                <label for="ip-address" class="block text-sm font-medium text-gray-300 mb-1">Plug IP Address</label>
                <input type="text" id="ip-address" placeholder="e.g., 192.168.1.100" class="w-full bg-gray-700 border-2 border-gray-600 text-white rounded-lg px-4 py-2 focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 focus:outline-none transition">
            </div>
            <button id="connect-button" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 shadow-md">
                Connect & Save IP
            </button>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast-notification" class="toast fixed bottom-5 right-5 bg-red-600 text-white py-2 px-4 rounded-lg shadow-lg">
        <p id="toast-message">Could not connect to the plug.</p>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const toggleButton = document.getElementById('toggle-button');
            const statusText = document.getElementById('status-text');
            const ipAddressInput = document.getElementById('ip-address');
            const connectButton = document.getElementById('connect-button');
            const powerIcon = toggleButton.querySelector('svg');
            const toastNotification = document.getElementById('toast-notification');
            const toastMessage = document.getElementById('toast-message');

            let plugState = 'off';
            let plugIp = null;
            let statusInterval = null;

            // --- UI Update Functions ---
            const updateUI = () => {
                if (plugIp) {
                    toggleButton.disabled = false;
                    if (plugState === 'on') {
                        statusText.textContent = 'Status: ON';
                        statusText.classList.remove('text-gray-400');
                        statusText.classList.add('text-green-400');
                        toggleButton.classList.remove('bg-gray-700');
                        toggleButton.classList.add('bg-cyan-500', 'shadow-cyan-500/50');
                        powerIcon.classList.remove('text-gray-500');
                        powerIcon.classList.add('text-white');
                    } else {
                        statusText.textContent = 'Status: OFF';
                        statusText.classList.remove('text-green-400');
                        statusText.classList.add('text-gray-400');
                        toggleButton.classList.add('bg-gray-700');
                        toggleButton.classList.remove('bg-cyan-500', 'shadow-cyan-500/50');
                        powerIcon.classList.add('text-gray-500');
                        powerIcon.classList.remove('text-white');
                    }
                } else {
                    toggleButton.disabled = true;
                    statusText.textContent = 'Not Connected';
                    statusText.classList.remove('text-green-400');
                    statusText.classList.add('text-gray-400');
                }
            };
            
            const showToast = (message, isError = true) => {
                toastMessage.textContent = message;
                toastNotification.classList.remove('bg-red-600', 'bg-green-600');
                toastNotification.classList.add(isError ? 'bg-red-600' : 'bg-green-600');
                toastNotification.classList.add('show');
                setTimeout(() => {
                    toastNotification.classList.remove('show');
                }, 3000);
            };

            // --- API Communication ---
            const sendRequest = async (endpoint) => {
                if (!plugIp) return null;
                try {
                    // Added a timeout to fetch requests to prevent long waits
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 3000); // 3-second timeout
                    const response = await fetch(`http://${plugIp}/${endpoint}`, {
                        signal: controller.signal
                    });
                    clearTimeout(timeoutId);
                    if (!response.ok) {
                       throw new Error('Network response was not ok');
                    }
                    // For status, we expect JSON. For on/off, we don't need to parse body.
                    if (endpoint === 'status') {
                        return await response.json();
                    }
                    return {success: true};
                } catch (error) {
                    console.error('Fetch error:', error);
                    showToast('Failed to communicate with plug.');
                    // Stop polling if connection fails
                    if(statusInterval) clearInterval(statusInterval);
                    plugIp = null; // Set IP to null to show 'Not Connected'
                    updateUI();
                    return null;
                }
            };

            const getStatus = async () => {
                const data = await sendRequest('status');
                if (data && typeof data.status !== 'undefined') {
                    plugState = data.status;
                    updateUI();
                }
            };

            // --- Event Listeners ---
            toggleButton.addEventListener('click', async () => {
                const newState = plugState === 'on' ? 'off' : 'on';
                const result = await sendRequest(newState);
                if(result) {
                   plugState = newState;
                   updateUI();
                }
            });

            connectButton.addEventListener('click', () => {
                const ip = ipAddressInput.value.trim();
                // Basic IP validation regex
                if (/^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$/.test(ip)) {
                    plugIp = ip;
                    localStorage.setItem('smartPlugIp', ip);
                    statusText.textContent = 'Connecting...';
                    statusText.classList.remove('text-green-400', 'text-gray-400');
                    statusText.classList.add('text-yellow-400');

                    if (statusInterval) clearInterval(statusInterval);

                    // Initial status check
                    getStatus().then(() => {
                        // Start polling for status updates only if initial connection was successful
                        if(plugIp) {
                            showToast('Connected!', false);
                            statusInterval = setInterval(getStatus, 5000);
                        }
                    });
                } else {
                    showToast('Please enter a valid IP address.');
                }
            });
            
            // --- Initialization ---
            const savedIp = localStorage.getItem('smartPlugIp');
            if (savedIp) {
                ipAddressInput.value = savedIp;
                connectButton.click(); // Auto-connect if an IP is saved
            }
        });
    </script>
</body>
</html>

